import Head from "next/head";
import Link from "next/link";
import { MongoClient } from "mongodb";
import { getSession } from "next-auth/react";
import { useState } from "react";

export async function getServerSideProps(context) {
  const session = await getSession(context);
  const userEmail = session.user.email

// tests to see if the user is signed in before rendering the page.
if (!session) {
  return {
    redirect: {
      destination: "/",
      permanent: false,
    },
  };
}

  // connect to mongodb
  const client = await MongoClient.connect(process.env.MONGODB_URI);
  const db = client.db(process.env.MONGODB_DB);

  // get all profiles from profile collection in db
  const profiles = await db.collection("profile").find().toArray();
  const findProfile = await db.collection("profile").findOne({userEmail});

  client.close();

  const serializedProfiles = JSON.parse(JSON.stringify(profiles));
  const serializedfindProfile = JSON.parse(JSON.stringify(findProfile));

  return {
    props: {
      findProfile: serializedfindProfile,
      profiles: serializedProfiles,
      email: userEmail
    },
  };
}



export default function Connections({ profiles, findProfile, email }) {
  const [hasProfile, setHasProfile] = useState(findProfile?.userEmail === email ? 'hidden' : '')
  
  
  return (
      <>
        <Head>
          <title>Create Next App</title>
          <meta name="description" content="Generated by create next app" />
          <meta name="viewport" content="width=device-width, initial-scale=1" />
        </Head>
        <main>
          <h2>Connections/Super Matches Page</h2>
          <Link href="/profile/new"><button className={`${hasProfile}`}>Set up Profile</button></Link>
          <section className="flex">
            {profiles.map((profile) => (
              <Link key={profile._id} href={`/profile/view/${profile._id}`}>
                <section
                  
                  className="bg-blue-200 w-60 h-60 text-2xl mx-2"
                >
                  <h3>{profile.sname}</h3>
                  <h4>{profile.rname}</h4>
                  <p>{profile.age}</p>
                  <p>{profile.location}</p>
                </section>
              </Link>
            ))}
          </section>
        </main>
      </>
    );
}
